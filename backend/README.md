# Jirehs Agent

A document processing and search service built with Python and FastAPI.

## Features

- Document ingestion and processing
- PDF parsing and text extraction
- Vector embeddings generation
- Semantic search capabilities
- REST API endpoints for document management and search

## Setup

1. Install dependencies:
```bash
uv sync
```

2. Set up environment variables:
```bash
cp .env.example .env
```

3. Run the application:
```bash
uv run main.py
```

## API Endpoints

- `POST /ingest` - Ingest documents
- `POST /search` - Search documents
- `POST /ask` - Ask questions about documents
- `GET /health` - Health check

## Database

The application uses SQLAlchemy with Alembic for database migrations.

### Database Migrations with Alembic

#### Quick Reference Commands

```bash
# Check current migration state
alembic current

# View migration history
alembic history

# Create migration from model changes (autogenerate)
alembic revision --autogenerate -m "description"

# Create empty migration (for manual changes)
alembic revision -m "description"

# Apply all pending migrations
alembic upgrade head

# Apply one migration at a time
alembic upgrade +1

# Rollback one migration
alembic downgrade -1

# Rollback to specific revision
alembic downgrade <revision_id>

# Preview SQL without executing
alembic upgrade head --sql
```

#### Development Workflow

**1. Check Migration Status**

Always check your current database state before making changes:

```bash
alembic current
alembic history --verbose
```

**2. Make Model Changes**

Edit your SQLAlchemy models in `src/models/`. For example, adding a new field:

```python
# src/models/paper.py
class Paper(Base):
    # ... existing fields ...
    citation_count = Column(Integer, default=0)  # NEW FIELD
```

**3. Generate Migration**

Let Alembic detect and generate the migration:

```bash
alembic revision --autogenerate -m "add citation count to papers"
```

This creates a new file in `alembic/versions/` with timestamp and description.

**4. Review Generated Migration**

Always review the generated migration file before applying. Autogenerate may miss:
- Renamed columns (appears as drop + add)
- Type changes
- Complex constraints
- Data migrations

**5. Apply Migration**

```bash
alembic upgrade head
```

**6. Test Rollback**

Always test that downgrades work:

```bash
alembic downgrade -1  # Rollback
alembic upgrade head  # Reapply
```

#### Common Scenarios

**Adding a New Table**

```bash
# 1. Create model in src/models/
# 2. Import in src/models/__init__.py
# 3. Update alembic/env.py imports if needed
# 4. Generate and apply
alembic revision --autogenerate -m "add new table"
alembic upgrade head
```

**Modifying Existing Columns**

```bash
# 1. Update model
# 2. Generate migration
alembic revision --autogenerate -m "modify column"
# 3. Review and potentially add data migration
# 4. Apply
alembic upgrade head
```

**Data Migrations (Manual)**

For custom SQL or data transformations:

```bash
alembic revision -m "populate citation counts"
```

Then edit the generated file:

```python
def upgrade() -> None:
    op.execute("""
        UPDATE papers p
        SET citation_count = (
            SELECT COUNT(*) FROM citations c WHERE c.paper_id = p.id
        )
    """)

def downgrade() -> None:
    op.execute("UPDATE papers SET citation_count = 0")
```

#### Best Practices

1. **Never edit applied migrations** - Once committed or applied to shared databases, create new migrations instead
2. **Keep migrations small** - Break large changes into multiple migrations
3. **Test both directions** - Always test upgrade and downgrade
4. **Version control migrations** - Commit migration files with your code changes
5. **Review autogenerated code** - Don't blindly trust autogenerate

#### Migration Files

Migration files are stored in `alembic/versions/` with the naming format:
```
YYYYMMDD_HHMM_<revision>_<slug>.py
```

Each migration has:
- `revision`: Unique identifier
- `down_revision`: Parent migration
- `upgrade()`: Apply changes
- `downgrade()`: Revert changes

## Configuration

Configure your environment in the `.env` file.

